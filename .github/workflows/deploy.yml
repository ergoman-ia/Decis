name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ‘‡ [í•µì‹¬] íŒŒì¼ ì´ë¦„ì„ ëª°ë¼ë„ ì°¾ì•„ì„œ ê³ ì¹˜ëŠ” ê°•ë ¥í•œ ìŠ¤í¬ë¦½íŠ¸
      - name: Inject Secrets Automatically
        env:
          FIREBASE_CONFIG_JSON: ${{ secrets.FIREBASE_CONFIG }}
          ADMIN_PW_VALUE: ${{ secrets.ADMIN_PW }}
        run: |
          python3 -c "
          import os
          import sys

          print('ğŸ” ì‘ì—… ì‹œì‘: HTML íŒŒì¼ì„ ìŠ¤ìº”í•©ë‹ˆë‹¤...')

          # 1. í™˜ê²½ë³€ìˆ˜ ì¤€ë¹„ (JSON ì¤‘ê´„í˜¸ ì•ˆì „ì¥ì¹˜ í¬í•¨)
          fb_config = os.environ.get('FIREBASE_CONFIG_JSON', '').strip()
          pw_value = os.environ.get('ADMIN_PW_VALUE', '').strip()

          if not fb_config:
              print('âŒ Error: GitHub Secret [FIREBASE_CONFIG]ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!')
              sys.exit(1)

          # ì‚¬ìš©ìê°€ { }ë¥¼ ë¹¼ë¨¹ì—ˆì„ ê²½ìš° ìë™ ì¶”ê°€
          if not fb_config.startswith('{'):
              fb_config = '{' + fb_config + '}'

          # 2. í˜„ì¬ í´ë”ì˜ ëª¨ë“  íŒŒì¼ì„ ê²€ì‚¬
          target_found = False
          
          # í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ ëª©ë¡ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
          print(f'ğŸ“‚ í˜„ì¬ í´ë” íŒŒì¼ ëª©ë¡: {os.listdir(os.getcwd())}')

          for filename in os.listdir(os.getcwd()):
              if filename.endswith('.html'):
                  try:
                      with open(filename, 'r', encoding='utf-8') as f:
                          content = f.read()

                      # í‘œì‹(Placeholder)ì´ ìˆëŠ”ì§€ í™•ì¸
                      if 'FIREBASE_CONFIG_PLACEHOLDER' in content:
                          print(f'ğŸ‘‰ ë°œê²¬! [{filename}] íŒŒì¼ì—ì„œ í‘œì‹ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.')
                          
                          # êµì²´ ì‘ì—…
                          new_content = content.replace('FIREBASE_CONFIG_PLACEHOLDER', fb_config)
                          new_content = new_content.replace('ADMIN_PW_PLACEHOLDER', pw_value)

                          with open(filename, 'w', encoding='utf-8') as f:
                              f.write(new_content)
                          
                          print(f'âœ… ìˆ˜ì • ì™„ë£Œ: [{filename}] ë¹„ë°€ë²ˆí˜¸ ì£¼ì… ì„±ê³µ!')
                          target_found = True
                      else:
                          print(f'   Skipping [{filename}]: í‘œì‹ì´ ì—†ìŠµë‹ˆë‹¤.')
                          
                  except Exception as e:
                      print(f'âš ï¸ Warning: {filename} ì½ê¸° ì‹¤íŒ¨ - {e}')

          # 3. ê²°ê³¼ í™•ì¸
          if not target_found:
              print('\nâŒ [ì¹˜ëª…ì  ì˜¤ë¥˜] í‘œì‹(PLACEHOLDER)ì´ ìˆëŠ” HTML íŒŒì¼ì„ í•˜ë‚˜ë„ ëª» ì°¾ì•˜ìŠµë‹ˆë‹¤!')
              print('   - íŒŒì¼ëª…ì´ë‚˜ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.')
              print('   - ì½”ë“œ ì•ˆì— FIREBASE_CONFIG_PLACEHOLDER ì² ìê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.')
              sys.exit(1) # ë°°í¬ ì¤‘ë‹¨ (ë¹¨ê°„ë¶ˆ ëœ¸)
          else:
              print('\nğŸ‰ ì‘ì—… ì„±ê³µ! ë°°í¬ë¥¼ ê³„ì†í•©ë‹ˆë‹¤.')
          "

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
