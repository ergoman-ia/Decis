<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ë§‰ ì¡°ë‚œ ì‹œë®¬ë ˆì´ì…˜ Master Final</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --border: #e0e0e0;
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 1.8rem;
            margin: 0;
            color: var(--primary);
            letter-spacing: -1px;
        }

        .admin-link {
            color: #aaa;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.3s;
        }

        .admin-link:hover {
            color: var(--accent);
        }

        .screen {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--primary);
            font-size: 0.95rem;
        }

        select,
        input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #fff;
        }

        select:focus,
        input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-blue {
            background-color: var(--accent);
        }

        .btn-green {
            background-color: var(--success);
        }

        .btn-gray {
            background-color: #95a5a6;
        }

        .btn-red {
            background-color: var(--danger);
        }

        .btn-purple {
            background-color: #8e44ad;
        }

        .btn-orange {
            background-color: var(--warning);
            color: #fff;
        }

        .btn-sm {
            width: auto;
            padding: 6px 12px;
            font-size: 0.85rem;
            margin: 0;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #ccc;
            color: #666;
        }

        .checkbox-wrapper {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .checkbox-wrapper input {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-bottom: 0;
            cursor: pointer;
        }

        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            color: #555;
            font-weight: 500;
        }

        .table-wrap {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
            font-size: 0.95rem;
        }

        th,
        td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f1f3f5;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
            border-bottom: 2px solid #ddd;
        }

        .col-narrow {
            width: 60px;
        }

        .col-med {
            width: 100px;
        }

        .col-wide {
            width: auto;
            text-align: left;
        }

        .bg-group {
            background-color: #e3f2fd;
            color: var(--accent);
            font-weight: 700;
        }

        .bg-expert {
            background-color: #fff9c4;
            font-weight: 700;
            color: #d4ac0d;
        }

        .interpret-box {
            font-size: 0.9rem;
            line-height: 1.5;
            color: #555;
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .tag-good {
            background: #d4edda;
            color: #155724;
        }

        .tag-bad {
            background: #f8d7da;
            color: #721c24;
        }

        .tag-neutral {
            background: #e2e3e5;
            color: #383d41;
        }

        .warning-text {
            color: #c0392b;
            font-weight: 600;
            font-size: 0.85rem;
            display: block;
            margin-top: 4px;
        }

        .error-input {
            border: 2px solid var(--danger) !important;
            background-color: #fff5f5 !important;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
            display: inline-block;
            min-width: 30px;
        }

        .bg-good {
            background-color: var(--success);
        }

        .bg-bad {
            background-color: var(--danger);
        }

        .bg-neutral {
            background-color: #95a5a6;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        /* í†µí•© ê´€ë¦¬ìš© í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .manage-table th {
            background-color: #34495e;
            color: white;
        }

        .manage-table td {
            font-size: 0.9rem;
            vertical-align: middle;
        }

        .manage-table tr:hover {
            background-color: #f1f1f1;
        }

        .role-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .role-group {
            background: #e3f2fd;
            color: #3498db;
        }

        .role-indiv {
            background: #f5f5f5;
            color: #666;
        }

        .data-preview {
            font-family: monospace;
            color: #555;
            font-size: 0.85rem;
            letter-spacing: -0.5px;
        }

        .danger-zone {
            margin-top: 30px;
            padding: 20px;
            border: 2px dashed var(--danger);
            border-radius: 12px;
            background-color: #fff5f5;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header-top">
            <h1>ğŸŒµ ì‚¬ë§‰ ì¡°ë‚œ ì‹œë®¬ë ˆì´ì…˜ <span style="font-size:0.5em; color:#999; vertical-align:middle;">Master Final</span>
            </h1>
            <span class="admin-link" onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ</span>
        </div>

        <div id="adminScreen" class="screen">
            <div class="card" id="adminLogin" style="max-width:400px; margin:20px auto;">
                <h3 style="text-align:center; margin-top:0;">ğŸ”’ ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
                <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button class="btn btn-primary btn-blue" onclick="checkAdmin()">ë¡œê·¸ì¸</button>
                <button class="btn btn-outline" onclick="location.reload()" style="margin-top:10px;">ëŒì•„ê°€ê¸°</button>
            </div>

            <div id="adminPanel" style="display:none;">
                <div style="text-align:right; margin-bottom:20px;">
                    <button class="btn btn-outline btn-sm" onclick="location.reload()">ê´€ë¦¬ì ì¢…ë£Œ</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">

                    <div class="card"
                        style="margin:0; border-left: 5px solid var(--accent); display:flex; flex-direction:column;">
                        <h4 style="margin:0 0 15px 0; color:var(--accent);">ğŸ“š êµê³¼ê³¼ì • ë° íŒ€ ì„¤ì •</h4>
                        <label style="font-size:0.85rem;">ìƒˆ ê³¼ì • ì¶”ê°€ (íŒ€ ê°œìˆ˜ ì§€ì •)</label>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input type="text" id="newSessionName" placeholder="ì˜ˆ: 1ì°¨_ì‹ ì…êµìœ¡" style="margin:0; flex:2;">
                            <input type="number" id="newSessionTeamCnt" placeholder="íŒ€ ìˆ˜" value="7"
                                style="margin:0; width:80px; flex:1;">
                            <button class="btn btn-blue btn-sm" onclick="addSession()">ì¶”ê°€</button>
                        </div>
                        <div
                            style="flex-grow:1; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                            <div id="sessionListAdmin"></div>
                        </div>
                    </div>

                    <div class="card"
                        style="margin:0; border-left: 5px solid var(--warning); display:flex; flex-direction:column; justify-content:center; text-align:center;">
                        <h4 style="margin:0 0 20px 0; color:var(--warning);">ğŸ“Š ê²°ê³¼ ë¶„ì„ ì„¼í„°</h4>
                        <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">
                            ì…ë ¥ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ<br>íŒ€ë³„ ì‹œë„ˆì§€ì™€ ê°œì¸ ì—­ëŸ‰ì„ ë¶„ì„í•©ë‹ˆë‹¤.
                        </p>
                        <div style="display:flex; flex-direction:column; gap:15px; align-items:center;">
                            <button class="btn btn-purple" onclick="goToAllResultScreen()" style="width:80%;">ğŸ† ì „ì²´ ì¢…í•©
                                ê²°ê³¼ (í•´ì„ í¬í•¨)</button>
                            <button class="btn btn-gray" onclick="viewDashboard()" style="width:80%;">ğŸ‘€ ê°œë³„ íŒ€ ìƒì„¸
                                í˜„í™©íŒ</button>
                        </div>
                    </div>
                </div>

                <div class="card" style="border-left: 5px solid #2980b9;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0; color:#2980b9;">ğŸ—‚ï¸ ì‹¤ì‹œê°„ ì…ë ¥ ë°ì´í„° ê´€ë¦¬ (ê°œë³„ ì‚­ì œ)</h4>
                        <button class="btn btn-gray btn-sm" onclick="loadAllDataForAdmin()">ğŸ”„ ì „ì²´ ë°ì´í„° ì¡°íšŒ</button>
                    </div>
                    <div id="manageDataList" class="table-wrap" style="max-height: 300px; overflow-y: auto;">
                        <p style="text-align:center; padding:20px; color:#aaa;">ì¡°íšŒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì…ë ¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                </div>


                <div class="danger-zone">
                    <h4 style="margin:0 0 10px 0; color:var(--danger);">â›” ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ë…„ë§ ì •ì‚°ìš©)</h4>
                    <p style="font-size:0.9rem; color:#c0392b; margin-bottom:15px;">
                        ëª¨ë“  êµê³¼ê³¼ì • ëª©ë¡ê³¼ ì…ë ¥ëœ ì ìˆ˜ ë°ì´í„°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•©ë‹ˆë‹¤.<br>
                        <strong>ì´ ì‘ì—…ì€ ì ˆëŒ€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong>
                    </p>
                    <button class="btn btn-red" onclick="deleteAllDatabase()">âš ï¸ ëª¨ë“  DB ë°ì´í„° ë° ê³¼ì • ì‚­ì œ</button>
                </div>
            </div>
        </div>

        <div id="joinScreen" class="screen active">
            <div class="card" style="max-width:500px; margin:40px auto; text-align:center;">
                <h3 style="margin-top:0;">ğŸ‘‹ ì°¸ê°€ì ì…ì¥</h3>
                <p style="color:#666; font-size:0.95rem;">ê´€ë¦¬ìê°€ ê°œì„¤í•œ ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”.</p>

                <div style="text-align:left; margin-top:30px;">
                    <label>ğŸ“Œ êµê³¼ê³¼ì • (Session)</label>
                    <select id="userSessionSelect" onchange="onUserSessionChange()">
                        <option value="">ëª©ë¡ ë¡œë”© ì¤‘...</option>
                    </select>

                    <label>ğŸ‘¥ ì†Œì† íŒ€</label>
                    <select id="teamSelect">
                        <option value="">ê³¼ì •ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                    </select>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="isLeaderCheck">
                        <label for="isLeaderCheck">
                            ì„œê¸° (ì ìˆ˜ ì…ë ¥ ë‹´ë‹¹ì)
                            <br><span style="font-size:0.8rem; color:#888; font-weight:normal;">* íŒ€ í•©ì˜ ê²°ê³¼ë¥¼ ì¶”ê°€ë¡œ
                                ì…ë ¥í•©ë‹ˆë‹¤.</span>
                        </label>
                    </div>
                </div>

                <button class="btn btn-blue" onclick="enterSim()" style="margin-top:20px;">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
            </div>
        </div>

        <div id="inputScreen" class="screen">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div>
                        <h3 id="inputTitle" style="margin:0;"></h3>
                        <span id="roleBadge" class="badge bg-neutral" style="margin-top:5px;">ê°œì¸ ì°¸ê°€ì</span>
                    </div>
                </div>

                <div
                    style="background:#eef2f5; padding:15px; border-radius:8px; margin-bottom:20px; font-size:0.9rem; border-left:4px solid var(--primary); line-height:1.6;">
                    <strong>[ì…ë ¥ ê°€ì´ë“œ]</strong><br>
                    ì‚¬ë§‰ ì¡°ë‚œ ìƒí™©ì—ì„œ ì‚´ì•„ë‚¨ê¸° ìœ„í•´ ê°€ì¥ ì¤‘ìš”í•œ í’ˆëª©ë¶€í„° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br>
                    1ìœ„(ê°€ì¥ ì¤‘ìš”) ~ 15ìœ„(ê°€ì¥ ëœ ì¤‘ìš”)ë¥¼ ì¤‘ë³µ ì—†ì´ ì…ë ¥í•˜ì„¸ìš”.
                </div>

                <div class="table-wrap">
                    <table id="inputTable">
                        <thead id="inputThead"></thead>
                        <tbody id="inputBody"></tbody>
                    </table>
                </div>

                <div style="margin-top:20px; display:flex; gap:10px;">
                    <button class="btn btn-green" onclick="submitData()">ğŸ’¾ ì œì¶œ ë° ì €ì¥</button>
                    <button class="btn btn-gray" onclick="location.reload()">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <div id="waitScreen" class="screen">
            <div class="card" style="text-align:center; padding:50px 20px;">
                <div style="font-size:3rem; margin-bottom:20px;">âœ…</div>
                <h2 style="color:var(--success); margin:0;">ì œì¶œ ì™„ë£Œ</h2>
                <p style="font-size:1.1rem; color:#555;">ì ìˆ˜ê°€ ì•ˆì „í•˜ê²Œ ì‹œìŠ¤í…œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <hr style="width:50px; margin:20px auto; border-top:2px solid #eee;">
                <button class="btn btn-outline btn-sm" onclick="location.reload()" style="margin-top:30px;">ì²˜ìŒ
                    í™”ë©´ìœ¼ë¡œ</button>
            </div>
        </div>

        <div id="dashScreen" class="screen">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>ğŸ“Š ê°œë³„ íŒ€ ìƒì„¸ í˜„í™©</h3>
                    <button class="btn btn-outline btn-sm" onclick="toggleAdmin()">ëŒì•„ê°€ê¸°</button>
                </div>

                <div
                    style="display:flex; gap:15px; margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
                    <div style="flex:1;">
                        <label style="margin-bottom:5px; font-size:0.85rem;">êµê³¼ê³¼ì •</label>
                        <select id="dashSessionSelect" onchange="onDashSessionChange()" style="margin:0;"></select>
                    </div>
                    <div style="flex:1;">
                        <label style="margin-bottom:5px; font-size:0.85rem;">íŒ€ ì„ íƒ</label>
                        <select id="dashTeamSelect" onchange="loadDash()" style="margin:0;"></select>
                    </div>
                </div>

                <div id="dashContent" class="table-wrap">
                    <p style="text-align:center; padding:30px; color:#999;">ë¶„ì„í•  íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <div id="allResultScreen" class="screen">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>ğŸ† ì „ì²´ ì¢…í•© ë¶„ì„ ê²°ê³¼</h3>
                    <button class="btn btn-outline btn-sm" onclick="toggleAdmin()">ëŒì•„ê°€ê¸°</button>
                </div>

                <div
                    style="background:#f0f8ff; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #b6e0fe;">
                    <label style="margin-bottom:5px; font-size:0.9rem;">ğŸ“‚ ë¶„ì„í•  êµê³¼ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”</label>
                    <select id="resultViewSelect" onchange="loadResultTable()"
                        style="margin:0; font-weight:bold; color:var(--accent);">
                        <option value="">ì„ íƒ...</option>
                    </select>
                </div>

                <div id="allResultContent" class="table-wrap">
                    <p style="text-align:center; padding:30px; color:#aaa;">ê³¼ì •ì„ ì„ íƒí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, collection, getDocs }
            from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // ğŸ‘‡ [í•µì‹¬ ë³€ê²½] secrets.js íŒŒì¼ì—ì„œ ë³€ìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤! (ì´ì œ PLACEHOLDER í•„ìš” ì—†ìŒ)
        import { FIREBASE_CONFIG, ADMIN_PASSWORD } from "./secrets.js";

        let app, db;
        // ê°€ì ¸ì˜¨ FIREBASE_CONFIGë¥¼ ë°”ë¡œ ì‚¬ìš©
        try { app = initializeApp(FIREBASE_CONFIG); db = getFirestore(app); }
        catch (e) { console.error(e); alert("Firebase ì„¤ì • ì˜¤ë¥˜! ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”."); }

        let config = { teamCount: 7, memberCount: 5 };
        
        // ê°€ì ¸ì˜¨ ADMIN_PASSWORDë¥¼ ë°”ë¡œ ì‚¬ìš© (ì´ë¦„ì„ ë§ì¶”ê¸° ìœ„í•´ ë³€ìˆ˜ëª… í†µì¼)
        const ADMIN_PW = ADMIN_PASSWORD;

        const itemsData = [
            { name: "ì†ì „ë“± (ë°°í„°ë¦¬ 4ê°œ)", expert: 4 }, { name: "ì­í¬ ë‚˜ì´í”„", expert: 6 },
            { name: "í•­ê³µ ì§€ë„", expert: 12 }, { name: "ëŒ€í˜• ì²œë§‰", expert: 7 },
            { name: "ë‚˜ì¹¨ë°˜", expert: 11 }, { name: "êµ¬ê¸‰ì˜ì•½í’ˆ", expert: 10 },
            { name: "45êµ¬ê²½ ê¶Œì´", expert: 8 }, { name: "ë‚™í•˜ì‚°", expert: 5 },
            { name: "ì†Œê¸ˆ í•œ ë´‰ì§€", expert: 15 }, { name: "ë¬¼ 2ë¦¬í„°/ì¸", expert: 3 },
            { name: "ì‚¬ë§‰ ì•ˆë‚´ì±…ì", expert: 13 }, { name: "ì„ ê¸€ë¼ìŠ¤", expert: 9 },
            { name: "ìœ„ìŠ¤í‚¤ 2ë¦¬í„°", expert: 14 }, { name: "ì™¸íˆ¬ í•œ ë²Œ/ì¸", expert: 2 },
            { name: "í™”ì¥ìš© ì†ê±°ìš¸", expert: 1 }
        ];

        window.onload = async () => {
            await loadSessionList();
        };

        let sessionList = [];

        async function loadSessionList() {
            onSnapshot(doc(db, "settings", "courses"), (docSnap) => {
                sessionList = [];
                if (docSnap.exists() && docSnap.data().list) sessionList = docSnap.data().list;
                updateSelectOptions(sessionList);
                renderAdminSessionList(sessionList);
            });
        }

        function updateSelectOptions(courses) {
            const selects = ['userSessionSelect', 'dashSessionSelect', 'adminSessionSelect', 'resultViewSelect', 'manageSessionSelect'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const current = el.value;
                el.innerHTML = "";
                courses.forEach(c => el.innerHTML += `<option value="${c}">${c}</option>`);

                if (['dashSessionSelect', 'resultViewSelect', 'userSessionSelect', 'manageSessionSelect'].includes(id)) {
                    el.innerHTML = "<option value=''>ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>" + el.innerHTML;
                    el.value = "";
                } else {
                    if (courses.includes(current)) el.value = current;
                }
            });
        }

        function setupOptions() {
            const tSel = document.getElementById('teamSelect');
            const dtSel = document.getElementById('dashTeamSelect');
            tSel.innerHTML = "";
            dtSel.innerHTML = "<option value=''>íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>";
        }

        // --- ê´€ë¦¬ì ê¸°ë³¸ ---
        window.toggleAdmin = () => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('adminScreen').classList.add('active');
        }
        window.checkAdmin = () => {
            if (document.getElementById('adminPw').value === ADMIN_PW) {
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
            } else alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
        }
        window.saveConfig = async () => {
            config.teamCount = parseInt(document.getElementById('cfgTeamCount').value);
            await setDoc(doc(db, "settings", "config"), config);
            alert("ì„¤ì • ì €ì¥ë¨.");
            setupOptions();
        }

        // [ê³¼ì • ì¶”ê°€ ìˆ˜ì •] íŒ€ ìˆ˜ í¬í•¨
        window.addSession = async () => {
            const name = document.getElementById('newSessionName').value.trim();
            const cnt = parseInt(document.getElementById('newSessionTeamCnt').value) || 7;
            if (!name) return alert("ê³¼ì •ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

            await updateDoc(doc(db, "settings", "courses"), { list: arrayUnion(name) });
            await setDoc(doc(db, "course_configs", name), { teamCount: cnt });

            document.getElementById('newSessionName').value = "";
            alert(`'${name}' ê³¼ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (íŒ€: ${cnt}ê°œ)`);
        }

        window.deleteSession = async (name) => {
            if (confirm(`'${name}' ê³¼ì •ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                await updateDoc(doc(db, "settings", "courses"), { list: arrayRemove(name) });
                await deleteDoc(doc(db, "course_configs", name));
            }
        }
        function renderAdminSessionList(courses) {
            const div = document.getElementById('sessionListAdmin'); div.innerHTML = "";
            courses.forEach(c => {
                div.innerHTML += `<div class="session-item"><span class="session-name">ğŸ“‚ ${c}</span><button class="btn btn-red btn-sm" onclick="deleteSession('${c}')">ì‚­ì œ</button></div>`;
            });
        }

        // [ì „ì²´ ì‚­ì œ]
        window.deleteAllDatabase = async () => {
            if (!confirm("âš ï¸ ê²½ê³ : ëª¨ë“  ê³¼ì •ê³¼ ì ìˆ˜ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!\nì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            if (!confirm("âš ï¸ ë§ˆì§€ë§‰ í™•ì¸: ì´ ì‘ì—…ì€ ì ˆëŒ€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

            const btn = document.querySelector('.danger-zone .btn');
            btn.innerText = "ì‚­ì œ ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)";
            btn.disabled = true;

            try {
                for (const sess of sessionList) {
                    let tCount = 7;
                    try {
                        const cfg = await getDoc(doc(db, "course_configs", sess));
                        if (cfg.exists()) tCount = cfg.data().teamCount;
                    } catch (e) { }

                    for (let i = 1; i <= tCount; i++) {
                        const teamId = `team_${i}`;
                        const q = collection(db, "sessions", sess, "teams", teamId, "submissions");
                        const snap = await getDocs(q);
                        const delPromises = [];
                        snap.forEach(d => delPromises.push(deleteDoc(d.ref)));
                        await Promise.all(delPromises);
                    }
                    await deleteDoc(doc(db, "course_configs", sess));
                }
                await setDoc(doc(db, "settings", "courses"), { list: [] });

                alert("âœ… ì´ˆê¸°í™” ì™„ë£Œ! ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();

            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                btn.innerText = "âš ï¸ ëª¨ë“  DB ë°ì´í„° ë° ê³¼ì • ì‚­ì œ";
                btn.disabled = false;
            }
        }

        // [í†µí•© ë°ì´í„° ì¡°íšŒ]
        window.loadAllDataForAdmin = async () => {
            const listDiv = document.getElementById('manageDataList');
            listDiv.innerHTML = "<div style='text-align:center; padding:20px;'>ë°ì´í„°ë¥¼ ìŠ¤ìº” ì¤‘ì…ë‹ˆë‹¤...</div>";

            try {
                let allDocs = [];
                for (const sess of sessionList) {
                    let tCount = 7;
                    const cfg = await getDoc(doc(db, "course_configs", sess));
                    if (cfg.exists()) tCount = cfg.data().teamCount;

                    const teamPromises = [];
                    for (let i = 1; i <= tCount; i++) {
                        const teamId = `team_${i}`;
                        const q = collection(db, "sessions", sess, "teams", teamId, "submissions");
                        teamPromises.push(
                            getDocs(q).then(snap => {
                                snap.forEach(doc => {
                                    allDocs.push({ sess: sess, teamName: `${i}íŒ€`, teamId: teamId, id: doc.id, data: doc.data() });
                                });
                            })
                        );
                    }
                    await Promise.all(teamPromises);
                }

                if (allDocs.length === 0) {
                    listDiv.innerHTML = "<p style='text-align:center; padding:20px; color:#666;'>ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                let html = `
                <table class="manage-table">
                    <thead><tr><th>êµìœ¡ ê³¼ì •</th><th>íŒ€</th><th>êµ¬ë¶„</th><th>ì…ë ¥ê°’ (ìš”ì•½)</th><th style="width:50px;">ì‚­ì œ</th></tr></thead>
                    <tbody>
            `;
                allDocs.forEach(item => {
                    const typeLabel = item.data.type === 'group' ? '<span class="role-badge role-group">ì§‘ë‹¨</span>' : '<span class="role-badge role-indiv">ê°œì¸</span>';
                    const ranks = item.data.ranks ? item.data.ranks.slice(0, 5).join(", ") + ".." : "-";
                    html += `<tr><td>${item.sess}</td><td>${item.teamName}</td><td style="text-align:left;">${typeLabel}</td><td class="data-preview">${ranks}</td><td><button class="btn btn-red btn-sm" onclick="deleteDataGlobal('${item.sess}', '${item.teamId}', '${item.id}')">ğŸ—‘ï¸</button></td></tr>`;
                });
                html += "</tbody></table>";
                listDiv.innerHTML = html;
            } catch (e) { console.error(e); listDiv.innerHTML = "ì˜¤ë¥˜ ë°œìƒ: " + e.message; }
        }

        window.deleteAllDatabase = async () => {
            if (!confirm("âš ï¸ ê²½ê³ : ëª¨ë“  ê³¼ì •ê³¼ ì ìˆ˜ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!")) return;

            // 1. CSV ë°±ì—… ì œì•ˆ
            if (confirm("ë°ì´í„° ì‚­ì œ ì „, í˜„ì¬ê¹Œì§€ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ CSV(ì—‘ì…€)ë¡œ ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¶Œì¥: 'í™•ì¸'ì„ ëˆ„ë¥´ë©´ ë‹¤ìš´ë¡œë“œ í›„ ì‚­ì œë©ë‹ˆë‹¤)")) {
                await exportAllDataToCSV();
            }

            if (!confirm("âš ï¸ ë§ˆì§€ë§‰ í™•ì¸: ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆê±°ë‚˜ í•„ìš” ì—†ìœ¼ì‹­ë‹ˆê¹Œ?\n'í™•ì¸'ì„ ëˆ„ë¥´ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.")) return;

            const btn = document.querySelector('.danger-zone .btn');
            btn.innerText = "ì‚­ì œ ì¤‘... (í™”ë©´ì„ ë‹«ì§€ ë§ˆì„¸ìš”)";
            btn.disabled = true;

            try {
                // ëª¨ë“  ì„¸ì…˜ ìˆœíšŒí•˜ë©° ë°ì´í„° ì‚­ì œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                for (const sess of sessionList) {
                    let tCount = 7;
                    try {
                        const cfg = await getDoc(doc(db, "course_configs", sess));
                        if (cfg.exists()) tCount = cfg.data().teamCount;
                    } catch (e) { }

                    for (let i = 1; i <= tCount; i++) {
                        const teamId = `team_${i}`;
                        const q = collection(db, "sessions", sess, "teams", teamId, "submissions");
                        const snap = await getDocs(q);
                        const delPromises = [];
                        snap.forEach(d => delPromises.push(deleteDoc(d.ref)));
                        await Promise.all(delPromises);
                    }
                    await deleteDoc(doc(db, "course_configs", sess));
                }
                await setDoc(doc(db, "settings", "courses"), { list: [] });

                alert("âœ… ì´ˆê¸°í™” ì™„ë£Œ! ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();

            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                btn.innerText = "âš ï¸ ëª¨ë“  DB ë°ì´í„° ë° ê³¼ì • ì‚­ì œ";
                btn.disabled = false;
            }
        }

        window.exportAllDataToCSV = async () => {
            const btn = document.querySelector('.danger-zone .btn');
            const originalText = btn.innerText;
            btn.innerText = "â³ ë°ì´í„° ë°±ì—… ìƒì„± ì¤‘...";

            try {
                let csvContent = "\uFEFF"; // í•œê¸€ ê¹¨ì§ ë°©ì§€ (BOM)
                // í—¤ë” ì‘ì„±
                csvContent += "ê³¼ì •ëª…,íŒ€ëª…,êµ¬ë¶„(ID),ì…ë ¥ì‹œê°„,";
                // í’ˆëª© 1~15 í—¤ë”
                itemsData.forEach((item, idx) => csvContent += `${item.name}(${idx + 1}),`);
                csvContent += "\n";

                // ëª¨ë“  ì„¸ì…˜ ë° íŒ€ ë°ì´í„° ìˆ˜ì§‘
                for (const sess of sessionList) {
                    let tCount = 7;
                    // íŒ€ ê°œìˆ˜ í™•ì¸
                    try {
                        const cfg = await getDoc(doc(db, "course_configs", sess));
                        if (cfg.exists()) tCount = cfg.data().teamCount;
                    } catch (e) { }

                    for (let i = 1; i <= tCount; i++) {
                        const teamId = `team_${i}`;
                        const q = collection(db, "sessions", sess, "teams", teamId, "submissions");
                        const snap = await getDocs(q);

                        snap.forEach(docSnap => {
                            const d = docSnap.data();
                            // ë°ì´í„° ì •ì œ
                            const type = d.type === 'group' ? 'ì§‘ë‹¨' : 'ê°œì¸';
                            const role = docSnap.id === 'group_scorer' ? 'ì„œê¸°' : docSnap.id;

                            // ì‹œê°„ í¬ë§· (YYYY-MM-DD HH:mm:ss)
                            let timeStr = "-";
                            if (d.timestamp) {
                                const date = d.timestamp.toDate();
                                timeStr = date.getFullYear() + "-" +
                                    String(date.getMonth() + 1).padStart(2, '0') + "-" +
                                    String(date.getDate()).padStart(2, '0') + " " +
                                    String(date.getHours()).padStart(2, '0') + ":" +
                                    String(date.getMinutes()).padStart(2, '0');
                            }

                            // CSV í–‰ ì‘ì„±
                            let row = `"${sess}","${i}íŒ€","${type}(${role})","${timeStr}",`;

                            // ì ìˆ˜ ë°°ì—´ (1~15)
                            if (d.ranks && Array.isArray(d.ranks)) {
                                row += d.ranks.join(",");
                            }
                            csvContent += row + "\n";
                        });
                    }
                }

                // ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `ì‚¬ë§‰ì¡°ë‚œ_ë°±ì—…_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert("CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. íŒŒì¼ì„ í™•ì¸ í›„ ì‚­ì œë¥¼ ê³„ì† ì§„í–‰í•˜ì„¸ìš”.");

            } catch (e) {
                console.error(e);
                alert("ë°±ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            } finally {
                btn.innerText = originalText;
            }
        }

        // --- ì‚¬ìš©ì ì„¸ì…˜ ë³€ê²½ -> íŒ€ ëª©ë¡ ë¡œë“œ (ë™ì ) ---
        window.onUserSessionChange = async () => {
            const sess = document.getElementById('userSessionSelect').value;
            const teamSel = document.getElementById('teamSelect');
            teamSel.innerHTML = "<option value=''>íŒ€ ëª©ë¡ ë¡œë”©ì¤‘...</option>";
            if (!sess) return;

            let tCount = 7;
            try {
                const cfg = await getDoc(doc(db, "course_configs", sess));
                if (cfg.exists()) tCount = cfg.data().teamCount;
            } catch (e) { }

            teamSel.innerHTML = "";
            for (let i = 1; i <= tCount; i++) {
                teamSel.innerHTML += `<option value="team_${i}">${i}íŒ€</option>`;
            }
        }

        // --- ì°¸ê°€ì ì…ë ¥ ---
        // [ìˆ˜ì • í›„] async í‚¤ì›Œë“œ ì¶”ê°€ë¨
        window.enterSim = async () => {
            const sessId = document.getElementById('userSessionSelect').value;
            const teamVal = document.getElementById('teamSelect').value;
            const teamText = document.getElementById('teamSelect').options[document.getElementById('teamSelect').selectedIndex]?.text;
            const isLeader = document.getElementById('isLeaderCheck').checked;

            if (!sessId || !teamVal) return alert("êµê³¼ê³¼ì •ê³¼ íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            // [ì¶”ê°€ëœ ë¡œì§] ì„œê¸°ë¼ë©´ ê¸°ì¡´ ë°ì´í„° í™•ì¸
            if (isLeader) {
                try {
                    // í•´ë‹¹ íŒ€ì˜ ì§‘ë‹¨ ì ìˆ˜(group_scorer) ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸
                    const docRef = doc(db, "sessions", sessId, "teams", teamVal, "submissions", "group_scorer");
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        // ë°ì´í„°ê°€ ì´ë¯¸ ìˆë‹¤ë©´ ì˜ì‚¬ ë¬»ê¸°
                        if (!confirm("ì´ë¯¸ ì§‘ë‹¨ ìš°ì„ ìˆœìœ„ê°€ ì…ë ¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            return; // 'ì·¨ì†Œ' ëˆ„ë¥´ë©´ ì…ì¥í•˜ì§€ ì•ŠìŒ
                        }
                    }
                } catch (e) {
                    console.error("DB í™•ì¸ ì¤‘ ì˜¤ë¥˜:", e);
                    // ì˜¤ë¥˜ê°€ ë‚˜ë„ ì¼ë‹¨ ì§„í–‰í•˜ê±°ë‚˜, alertì„ ë„ìš¸ ìˆ˜ ìˆìŒ (ì—¬ê¸°ì„  ì§„í–‰)
                }
            }

            sessionStorage.setItem("sim_isLeader", isLeader);

            // í™”ë©´ ì „í™˜ ë° ê·¸ë¦¬ê¸° (ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼)
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('inputScreen').classList.add('active');
            document.getElementById('inputTitle').innerText = `${teamText} ì…ë ¥`;

            const badge = document.getElementById('roleBadge');
            if (isLeader) { badge.innerText = "ì„œê¸° (íŒ€ ê²°ê³¼ í¬í•¨)"; badge.className = "badge bg-group"; }
            else { badge.innerText = "ê°œì¸ ì°¸ê°€ì"; badge.className = "badge bg-neutral"; }

            const thead = document.getElementById('inputThead');
            const tbody = document.getElementById('inputBody');

            // (ì´ì „ ë‹¨ê³„ì—ì„œ ìˆ˜ì •í•œ í—¤ë” ë¡œì§: ì„œê¸°ëŠ” ì§‘ë‹¨ë§Œ, ê°œì¸ì€ ê°œì¸ë§Œ)
            let headHtml = `<tr><th style="text-align:left;">í’ˆëª©</th>`;
            if (isLeader) {
                headHtml += `<th class="bg-group">íŒ€ í•©ì˜ ìˆœìœ„ (ì„œê¸° ì „ìš©)</th>`;
            } else {
                headHtml += `<th>ë‚˜ì˜ ê°œì¸ ìˆœìœ„</th>`;
            }
            headHtml += `</tr>`;
            thead.innerHTML = headHtml;

            tbody.innerHTML = "";
            itemsData.forEach((item, idx) => {
                let row = `<tr><td style="text-align:left;">${item.name}</td>`;
                if (isLeader) {
                    row += `<td><input type="number" class="rank-input group-rank" style="background:#e3f2fd;" data-idx="${idx}" min="1" max="15" oninput="checkDup(this)"></td>`;
                } else {
                    row += `<td><input type="number" class="rank-input indiv-rank" data-idx="${idx}" min="1" max="15" oninput="checkDup(this)"></td>`;
                }
                row += `</tr>`;
                tbody.innerHTML += row;
            });
        }

        window.checkDup = (input) => {
            let val = parseInt(input.value);
            if (val > 15 || val < 1) { input.value = ""; return; }
            const isGroup = input.classList.contains('group-rank');
            const selector = isGroup ? '.group-rank' : '.indiv-rank';
            const all = document.querySelectorAll(selector);
            const map = {};
            all.forEach(el => el.classList.remove('error-input'));
            all.forEach(el => { if (el.value) { if (map[el.value]) map[el.value].push(el); else map[el.value] = [el]; } });
            for (let k in map) { if (map[k].length > 1) map[k].forEach(el => el.classList.add('error-input')); }
        }

        window.submitData = async () => {
            const sessId = document.getElementById('userSessionSelect').value;
            const team = document.getElementById('teamSelect').value;
            const isLeader = (sessionStorage.getItem("sim_isLeader") === 'true');

            let ranks = [];
            let err = false;

            // ì„œê¸°ëƒ ì•„ë‹ˆëƒì— ë”°ë¼ ìˆ˜ì§‘ ëŒ€ìƒ(class)ì´ ë‹¤ë¦„
            let selector = isLeader ? '.group-rank' : '.indiv-rank';

            document.querySelectorAll(selector).forEach(el => {
                if (!el.value || el.classList.contains('error-input')) err = true;
                ranks.push(parseInt(el.value));
            });

            if (err) return alert("1~15ìœ„ ìˆœìœ„ë¥¼ ë¹ ì§ì—†ì´ ì¤‘ë³µ ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                if (isLeader) {
                    // [ì„œê¸°] ì§‘ë‹¨ ì ìˆ˜ë§Œ ì €ì¥ (ë®ì–´ì“°ê¸°)
                    await setDoc(doc(db, "sessions", sessId, "teams", team, "submissions", "group_scorer"), {
                        ranks: ranks, type: 'group', timestamp: new Date()
                    });
                } else {
                    // [ì¼ë°˜] ê°œì¸ ì ìˆ˜ë§Œ ì €ì¥ (ì¶”ê°€í•˜ê¸°)
                    await addDoc(collection(db, "sessions", sessId, "teams", team, "submissions"), {
                        ranks: ranks, type: 'individual', timestamp: new Date()
                    });
                }

                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById('waitScreen').classList.add('active');
            } catch (e) { console.error(e); alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message); }
        }

        // --- í˜„í™©íŒ ---
        window.viewDashboard = () => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('dashScreen').classList.add('active');
            document.getElementById('dashSessionSelect').value = "";
            document.getElementById('dashTeamSelect').value = "";
            document.getElementById('dashContent').innerHTML = "<p style='text-align:center; padding:30px; color:#999;'>ë¶„ì„í•  ê³¼ì •ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</p>";
        }

        window.onDashSessionChange = async () => {
            const sess = document.getElementById('dashSessionSelect').value;
            const tSel = document.getElementById('dashTeamSelect');
            if (!sess) { tSel.innerHTML = ""; return; }

            let tCount = 7;
            try {
                const cfg = await getDoc(doc(db, "course_configs", sess));
                if (cfg.exists()) tCount = cfg.data().teamCount;
            } catch (e) { }

            tSel.innerHTML = "<option value=''>íŒ€ ì„ íƒ</option>";
            for (let i = 1; i <= tCount; i++) tSel.innerHTML += `<option value="team_${i}">${i}íŒ€</option>`;
        }

        let unsub = null;
        window.loadDash = () => {
            const sessId = document.getElementById('dashSessionSelect').value;
            const team = document.getElementById('dashTeamSelect').value;
            const div = document.getElementById('dashContent');

            if (!sessId || !team) {
                div.innerHTML = "<p style='text-align:center; padding:30px; color:#999;'>ì„ íƒ ëŒ€ê¸° ì¤‘...</p>";
                return;
            }

            if (unsub) unsub();
            unsub = onSnapshot(collection(db, "sessions", sessId, "teams", team, "submissions"), (snap) => {
                const individuals = [];
                let groupData = null;
                snap.forEach(d => {
                    const data = d.data();
                    if (d.id === 'group_scorer') groupData = data.ranks;
                    else if (data.type === 'individual' || !data.type) individuals.push(data.ranks);
                });
                renderDash(individuals, groupData);
            });
        }

        function renderDash(individuals, groupData) {
            const div = document.getElementById('dashContent');
            if (individuals.length === 0 && !groupData) { div.innerHTML = "<p style='text-align:center; padding:20px;'>ì…ë ¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }

            let h = `<table><thead><tr><th>í’ˆëª©</th>`;
            individuals.forEach((_, i) => h += `<th class="col-narrow">P${i + 1}</th>`);
            h += `<th class="bg-group col-narrow">íŒ€</th><th class="bg-expert col-narrow">ì •ë‹µ</th></tr></thead><tbody>`;

            itemsData.forEach((item, idx) => {
                h += `<tr><td style="text-align:left;">${item.name}</td>`;
                individuals.forEach(indiv => h += `<td>${indiv ? indiv[idx] : "-"}</td>`);
                h += `<td class="bg-group">${groupData ? groupData[idx] : "-"}</td><td>${item.expert}</td></tr>`;
            });
            h += `</tbody></table>`;
            div.innerHTML = h;
        }

        // --- ì „ì²´ ê²°ê³¼ ---
        window.goToAllResultScreen = () => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('allResultScreen').classList.add('active');
            document.getElementById('resultViewSelect').value = "";
            document.getElementById('allResultContent').innerHTML = "<p style='text-align:center; padding:30px; color:#aaa;'>ê³¼ì •ì„ ì„ íƒí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>";
        }

        window.loadResultTable = async () => {
            const sessId = document.getElementById('resultViewSelect').value;
            const div = document.getElementById('allResultContent');

            if (!sessId) {
                div.innerHTML = "<p style='text-align:center; padding:30px; color:#aaa;'>ê³¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>";
                return;
            }

            div.innerHTML = "ë°ì´í„° ë¶„ì„ ì¤‘...";

            let tCount = 7;
            try {
                const cfg = await getDoc(doc(db, "course_configs", sessId));
                if (cfg.exists()) tCount = cfg.data().teamCount;
            } catch (e) { }

            let all = [];
            for (let i = 1; i <= tCount; i++) {
                try {
                    const snap = await getDocs(collection(db, "sessions", sessId, "teams", `team_${i}`, "submissions"));
                    let m = [], g = null;
                    snap.forEach(d => {
                        const data = d.data();
                        let r = data.ranks;
                        if (r) {
                            let err = r.reduce((a, v, k) => a + Math.abs(v - itemsData[k].expert), 0);
                            if (d.id === 'group_scorer') g = err;
                            else if (data.type === 'individual' || !data.type) m.push(err);
                        }
                    });

                    let stat = { name: `${i}íŒ€`, status: 'ëŒ€ê¸°', avg: 0, group: 0, gain: 0, best: 0, betterCnt: 0, count: 0, msg: "" };

                    if (m.length > 0 && g !== null) {
                        stat.status = 'ì™„ë£Œ'; stat.group = g; stat.avg = m.reduce((a, b) => a + b, 0) / m.length; stat.gain = stat.avg - stat.group;
                        stat.best = Math.min(...m); stat.betterCnt = m.filter(s => s < g).length;
                        stat.count = m.length; // ì¸ì› ìˆ˜ ì €ì¥

                        if (stat.gain > 0) stat.msg += `<div class="tag tag-good">ì‹œë„ˆì§€ ë°œìƒ</div><br>íŒ€ í† ì˜ê°€ íš¨ê³¼ì ì´ì—ˆìŠµë‹ˆë‹¤.`;
                        else if (stat.gain < 0) stat.msg += `<div class="tag tag-bad">ì—­íš¨ê³¼</div><br>ì§‘ë‹¨ ì‚¬ê³ ì˜ ì˜¤ë¥˜ ê°€ëŠ¥ì„±.`;
                        else stat.msg += `<div class="tag tag-neutral">ë³€í™” ì—†ìŒ</div>`;

                        if (stat.best < stat.group) {
                            stat.msg += `<span class="warning-text">â€» ì „ë¬¸ê°€(${stat.best}ì ) ì˜ê²¬ ë¬µì‚´ë¨</span>`;
                        }
                    }
                    all.push(stat);
                } catch (e) { }
            }

            let h = `<table><thead>
            <tr>
                <th class="col-narrow">íŒ€</th>
                <th class="col-narrow">ì¸ì›</th>
                <th class="col-med">ê°œì¸(í‰ê· )</th>
                <th class="col-med">ì§‘ë‹¨</th>
                <th class="col-med">ì´ë“</th>
                <th class="col-med">ìµœìš°ìˆ˜</th>
                <th class="col-med">ì´ˆì›”ì</th>
                <th class="col-wide">ì¢…í•© í•´ì„</th>
            </tr></thead><tbody>`;

            all.forEach(t => {
                if (t.status !== 'ì™„ë£Œ') {
                    h += `<tr style="color:#aaa;"><td>${t.name}</td><td colspan="7" style="text-align:left;">(ì…ë ¥ ëŒ€ê¸° ì¤‘...)</td></tr>`;
                } else {
                    let badge = t.gain > 0 ? 'bg-good' : (t.gain < 0 ? 'bg-bad' : 'bg-neutral');
                    let gainSign = t.gain > 0 ? '+' : '';
                    h += `<tr>
                    <td><strong>${t.name}</strong></td>
                    <td>${t.count}ëª…</td>
                    <td>${t.avg.toFixed(1)}</td>
                    <td style="color:var(--accent); font-weight:700;">${t.group}</td>
                    <td><span class="badge ${badge}">${gainSign}${t.gain.toFixed(1)}</span></td>
                    <td>${t.best}</td>
                    <td>${t.betterCnt}ëª…</td>
                    <td class="interpret-box">${t.msg}</td>
                </tr>`;
                }
            });
            h += `</tbody></table>`;
            div.innerHTML = h;
        }

        window.viewAllResultsAdmin = window.goToAllResultScreen;
    </script>
</body>


</html>





