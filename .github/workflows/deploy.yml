name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ‘‡ [í•µì‹¬] íŒŒì¼ ì´ë¦„ì„ ëª°ë¼ë„ "PLACEHOLDER"ë¥¼ ì°¾ì•„ë‚´ëŠ” ì§€ëŠ¥í˜• ìŠ¤í¬ë¦½íŠ¸
      - name: Inject Secrets Smartly
        env:
          FIREBASE_CONFIG_JSON: ${{ secrets.FIREBASE_CONFIG }}
          ADMIN_PW_VALUE: ${{ secrets.ADMIN_PW }}
        run: |
          python3 -c "
          import os

          # 1. Secret ì¤€ë¹„ (ì¤‘ê´„í˜¸ {} ìë™ ë³´ì •)
          fb_config = os.environ['FIREBASE_CONFIG_JSON'].strip()
          if not fb_config.startswith('{'):
              fb_config = '{' + fb_config + '}'
          
          pw_value = os.environ['ADMIN_PW_VALUE'].strip()

          found_file = False

          # 2. í˜„ì¬ í´ë”ì˜ ëª¨ë“  íŒŒì¼ì„ ë’¤ì ¸ì„œ HTML ì°¾ê¸°
          for filename in os.listdir('.'):
              if filename.endswith('.html'):
                  print(f'ğŸ” Scanning file: {filename}...')
                  
                  with open(filename, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # 3. í‘œì‹ì´ ìˆëŠ”ì§€ í™•ì¸
                  if 'FIREBASE_CONFIG_PLACEHOLDER' in content:
                      print(f'   ğŸ‘‰ Found placeholders in {filename}!')
                      
                      # 4. êµì²´ ì‘ì—…
                      new_content = content.replace('FIREBASE_CONFIG_PLACEHOLDER', fb_config)
                      new_content = new_content.replace('ADMIN_PW_PLACEHOLDER', pw_value)
                      
                      with open(filename, 'w', encoding='utf-8') as f:
                          f.write(new_content)
                      
                      print(f'   âœ… Secrets injected successfully into {filename}')
                      found_file = True
                      break # í•˜ë‚˜ ì°¾ì•˜ìœ¼ë©´ ì¢…ë£Œ (í•„ìš”ì‹œ ì œê±° ê°€ëŠ¥)

          if not found_file:
              print('âŒ Error: Could not find any HTML file with the placeholder!')
              print('   (íŒŒì¼ ì•ˆì— FIREBASE_CONFIG_PLACEHOLDER ê¸€ìê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”)')
              exit(1) # ê°•ì œë¡œ ì˜¤ë¥˜ ë°œìƒì‹œì¼œì„œ ë°°í¬ ì¤‘ë‹¨
          "

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
