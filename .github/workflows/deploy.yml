name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ‘‡ [ìˆ˜ì •ë¨] ë”°ì˜´í‘œê°€ ì ˆëŒ€ ë¹ ì§€ì§€ ì•Šë„ë¡ 'json' ëª¨ë“ˆì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - name: Create secrets.js
        env:
          FIREBASE_CONFIG_JSON: ${{ secrets.FIREBASE_CONFIG }}
          ADMIN_PW_VALUE: ${{ secrets.ADMIN_PW }}
        run: |
          python3 -c "
          import os
          import json  # ğŸ‘ˆ json ëª¨ë“ˆ ì¶”ê°€ (ë”°ì˜´í‘œ í•´ê²°ì‚¬)

          # 1. í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°
          fb_config = os.environ.get('FIREBASE_CONFIG_JSON', '').strip()
          pw_value = os.environ.get('ADMIN_PW_VALUE', '').strip()

          # 2. ì•ˆì „ì¥ì¹˜: JSON ì¤‘ê´„í˜¸ ì²´í¬
          if fb_config and not fb_config.startswith('{'):
              fb_config = '{' + fb_config + '}'
          
          # 3. ë¹„ë°€ë²ˆí˜¸ ì•ˆì „í•˜ê²Œ í¬ì¥í•˜ê¸° (ì´ê²Œ í•µì‹¬!)
          # json.dumpsë¥¼ ì“°ë©´ 'admin_0482' -> '"admin_0482"'ë¡œ (ë”°ì˜´í‘œ í¬í•¨í•´ì„œ) ë³€í™˜ë©ë‹ˆë‹¤.
          safe_pw = json.dumps(pw_value)

          # 4. secrets.js ë‚´ìš© ì‘ì„±
          # fb_configëŠ” ê°ì²´ ê·¸ëŒ€ë¡œ ë„£ê³ , pw_valueëŠ” í¬ì¥ëœ safe_pwë¥¼ ë„£ìŠµë‹ˆë‹¤.
          js_content = f'''
          export const FIREBASE_CONFIG = {fb_config};
          export const ADMIN_PASSWORD = {safe_pw};
          '''

          # 5. íŒŒì¼ ìƒì„±
          with open('secrets.js', 'w', encoding='utf-8') as f:
              f.write(js_content)
          
          print('âœ… secrets.js created successfully with safe quotes!')
          "
          
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


